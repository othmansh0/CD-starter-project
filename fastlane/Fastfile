# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do
  desc "ğŸ”‘ Setting up App Store Connect API key..."
  private_lane :setup_api_key do
    app_store_connect_api_key(
      key_id: ENV["API_KEY_ID"],
      issuer_id: ENV["API_ISSUER_ID"],
      key_content: ENV["API_KEY_BASE64"],
      is_key_content_base64: true,
      duration: 1200,
      in_house: false
    )
    UI.success("âœ… API key setup successful")
  end

  desc "ğŸ”§ Setup CI environment with proper keychain and certificates"
  private_lane :setup_ci_environment do
    # Create a temporary keychain for CI
    create_keychain(
      name: "fastlane_tmp_keychain",
      password: "temp_password",
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      lock_when_sleeps: false
    )
    
    # Download and import Apple WWDR certificates to avoid signing issues
    UI.message("ğŸ“¥ Downloading Apple WWDR certificates...")
    sh("curl -o /tmp/AppleWWDRCAG3.cer https://developer.apple.com/certificationauthority/AppleWWDRCAG3.cer")
    import_certificate(
      certificate_path: "/tmp/AppleWWDRCAG3.cer",
      keychain_name: "fastlane_tmp_keychain",
      keychain_password: "temp_password"
    )
    
    # Also import the newer G4 certificate for better compatibility
    sh("curl -o /tmp/AppleWWDRCAG4.cer https://www.apple.com/certificateauthority/AppleWWDRCAG4.cer")
    import_certificate(
      certificate_path: "/tmp/AppleWWDRCAG4.cer",
      keychain_name: "fastlane_tmp_keychain",
      keychain_password: "temp_password"
    )
    
    # Import Distribution certificate if available (for App Store builds)
    if ENV["DISTRIBUTION_CERTIFICATE"]
      UI.message("ğŸ“± Importing Distribution certificate...")
      
      # Decode and save the Distribution certificate
      sh("echo '#{ENV['DISTRIBUTION_CERTIFICATE']}' | base64 --decode > /tmp/distribution.p12")
      
      # Import the Distribution certificate (handle empty password)
      cert_password = ENV["DISTRIBUTION_PASSWORD"] || ""
      import_certificate(
        certificate_path: "/tmp/distribution.p12",
        certificate_password: cert_password,
        keychain_name: "fastlane_tmp_keychain",
        keychain_password: "temp_password"
      )
      
      UI.success("âœ… Distribution certificate imported")
    else
      UI.message("âš ï¸ No Distribution certificate provided - using cloud signing only")
    end
    
    UI.success("âœ… CI environment setup complete")
  end

  desc "ğŸ“± Create Development certificate if needed"
  private_lane :ensure_development_certificate do
    api_key = lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]
    
    begin
      # Try to get existing development certificate
      cert(
        development: true,
        username: ENV["APPLE_ID"] || "your_apple_id@example.com",
        team_id: ENV["DEVELOPMENT_TEAM"],
        api_key: api_key,
        keychain_path: "~/Library/Keychains/fastlane_tmp_keychain",
        keychain_password: "temp_password"
      )
      UI.success("âœ… Development certificate ready")
    rescue => ex
      UI.error("âš ï¸ Could not create development certificate: #{ex}")
      UI.important("ğŸ” This is expected in CI - will use cloud signing")
    end
  end

  desc "ğŸ§ª DIAGNOSTIC: Test API permissions"
  lane :diagnostic_api_permissions do
    UI.header("ğŸ§ª DIAGNOSTIC: Testing API permissions")
    
    setup_api_key
    api_key = lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]
    
    begin
      # Test listing apps
      apps = Spaceship::ConnectAPI::App.all(limit: 10)
      UI.success("âœ… Can list apps: #{apps.count} apps found")
      
      # Test listing certificates  
      certs = Spaceship::ConnectAPI::Certificate.all(limit: 10)
      UI.success("âœ… Can list certificates: #{certs.count} certificates found")
      
      # Test listing profiles
      profiles = Spaceship::ConnectAPI::Profile.all(limit: 10)
      UI.success("âœ… Can list provisioning profiles: #{profiles.count} profiles found")
      
      # Test app-specific profiles
      app_profiles = profiles.select { |p| p.bundle_id && p.bundle_id.identifier == "com.othmanshahrouri.cd.starter.project" }
      UI.message("ğŸ“± Profiles for bundle ID: #{app_profiles.count} found")
      
      if app_profiles.count == 0
        UI.important("âš ï¸ No provisioning profiles found for com.othmanshahrouri.cd.starter.project")
        UI.important("ğŸ’¡ This is likely the root cause - profiles need to be created")
      end
      
    rescue => ex
      UI.error("âŒ API permissions test failed: #{ex}")
      raise ex
    end
  end

  desc "ğŸ—ï¸ DIAGNOSTIC: Test Development build (should succeed)"
  lane :diagnostic_dev_build do
    UI.header("ğŸ§ª DIAGNOSTIC: Testing Development build (should succeed)")
    UI.message("ğŸ” This will prove the pipeline works - only Distribution certificates are blocked")
    
    setup_api_key
    setup_ci_environment
    
    # Enable automatic signing for development
    update_code_signing_settings(
      use_automatic_signing: true,
      team_id: ENV["DEVELOPMENT_TEAM"],
      targets: ["CD starter project"],
      code_sign_identity: "", # Let Xcode choose
      profile_name: "" # Let Xcode choose
    )
    
    UI.message("ğŸ—ï¸ Building for Development (testing permissions)...")
    
    begin
      gym(
        project: "CD starter project.xcodeproj",
        scheme: "CD starter project",
        configuration: "Debug",
        export_method: "development",
        output_directory: "./build",
        output_name: "CD_starter_project_DEV",
        clean: true,
        xcargs: "-allowProvisioningUpdates -authenticationKeyPath /tmp/AuthKey_#{ENV['API_KEY_ID']}.p8 -authenticationKeyID #{ENV['API_KEY_ID']} -authenticationKeyIssuerID #{ENV['API_ISSUER_ID']} DEVELOPMENT_TEAM=#{ENV['DEVELOPMENT_TEAM']}",
        export_options: {
          method: "development",
          signingStyle: "automatic",
          teamID: ENV["DEVELOPMENT_TEAM"]
        }
      )
      UI.success("ğŸ‰ Development build succeeded!")
      UI.message("ğŸ’¡ This proves your CI setup works - the issue is only with Distribution signing")
    rescue => ex
      UI.error("âŒ Development build failed: #{ex}")
      raise ex
    end
  end

  desc "âš™ï¸ Setup lane: Create missing provisioning profiles"
  lane :setup_profiles do
    UI.header("âš™ï¸ Creating missing provisioning profiles")
    
    setup_api_key
    api_key = lane_context[SharedValues::APP_STORE_CONNECT_API_KEY]
    
    begin
      # Create Development profile
      UI.message("ğŸ“± Creating Development provisioning profile...")
      get_provisioning_profile(
        app_identifier: "com.othmanshahrouri.cd.starter.project",
        api_key: api_key,
        development: true,
        force: true,
        filename: "Development_Profile.mobileprovision"
      )
      UI.success("âœ… Development profile created")
      
      # Create App Store profile  
      UI.message("ğŸ“± Creating App Store provisioning profile...")
      get_provisioning_profile(
        app_identifier: "com.othmanshahrouri.cd.starter.project",
        api_key: api_key,
        force: true,
        filename: "AppStore_Profile.mobileprovision"
      )
      UI.success("âœ… App Store profile created")
      
    rescue => ex
      UI.error("âŒ Profile creation failed: #{ex}")
      UI.important("ğŸ’¡ This might be due to missing certificates or insufficient permissions")
      raise ex
    end
  end

  desc "ğŸ§ª TEST: App Store build with Development export (to test full pipeline)"
  lane :test_app_store_build do
    setup_api_key
    setup_ci_environment
    
    UI.message("ğŸ§ª Testing full App Store build pipeline with Development export...")
    UI.message("ğŸ” This proves the entire pipeline works - only Distribution export is blocked")
    
    # Update code signing settings for automatic signing
    update_code_signing_settings(
      use_automatic_signing: true,
      team_id: ENV["DEVELOPMENT_TEAM"],
      targets: ["CD starter project"],
      code_sign_identity: "", # Let Xcode choose
      profile_name: "" # Let Xcode choose
    )

    UI.message("ğŸ—ï¸ Building for App Store (but exporting as Development)...")
    
    # Build the app with cloud signing - using development export to test permissions
    begin
      gym(
        project: "CD starter project.xcodeproj",
        scheme: "CD starter project",
        configuration: "Release",
        export_method: "development", # Use development export to test pipeline
        output_directory: "./build",
        output_name: "CD_starter_project_TEST",
        clean: true,
        xcargs: "-allowProvisioningUpdates -authenticationKeyPath /tmp/AuthKey_#{ENV['API_KEY_ID']}.p8 -authenticationKeyID #{ENV['API_KEY_ID']} -authenticationKeyIssuerID #{ENV['API_ISSUER_ID']} DEVELOPMENT_TEAM=#{ENV['DEVELOPMENT_TEAM']}",
        export_options: {
          method: "development",
          signingStyle: "automatic",
          teamID: ENV["DEVELOPMENT_TEAM"]
        }
      )
      
      UI.success("ğŸ‰ TEST BUILD SUCCESSFUL!")
      UI.success("âœ… This proves your entire CI/CD pipeline works perfectly!")
      UI.important("ğŸ’¡ The only issue is Apple Developer account permissions for Distribution certificates")
      UI.message("ğŸ”§ Next steps: Get Admin/App Store Manager role or ask Admin to create Distribution certificates")
      
    rescue => ex
      UI.error("âŒ Test build failed: #{ex}")
      UI.important("ğŸ’¡ If this fails, there's a deeper configuration issue beyond permissions")
      raise ex
    end
  end

  desc "ğŸš€ Build and upload to TestFlight"
  lane :build_and_upload do
    setup_api_key
    setup_ci_environment
    
    # Skip manual certificate/profile management - let Xcode handle it all with cloud signing
    UI.message("ğŸ”§ Using Xcode automatic signing with cloud provisioning...")
    
    # Update code signing settings for automatic signing
    update_code_signing_settings(
      use_automatic_signing: true,
      team_id: ENV["DEVELOPMENT_TEAM"],
      targets: ["CD starter project"],
      code_sign_identity: "", # Let Xcode choose
      profile_name: "" # Let Xcode choose
    )

    UI.message("ğŸ—ï¸ Building for App Store with cloud signing...")
    
    # Build the app with cloud signing - no manual certificate management
    begin
      gym(
        project: "CD starter project.xcodeproj",
        scheme: "CD starter project",
        configuration: "Release",
        export_method: "app-store",
        output_directory: "./build",
        output_name: "CD_starter_project",
        clean: true,
        xcargs: "-allowProvisioningUpdates -authenticationKeyPath /tmp/AuthKey_#{ENV['API_KEY_ID']}.p8 -authenticationKeyID #{ENV['API_KEY_ID']} -authenticationKeyIssuerID #{ENV['API_ISSUER_ID']} DEVELOPMENT_TEAM=#{ENV['DEVELOPMENT_TEAM']}",
        export_options: {
          method: "app-store",
          signingStyle: "automatic",
          teamID: ENV["DEVELOPMENT_TEAM"]
        }
      )
      
      UI.success("ğŸ‰ Build completed successfully!")
      
      # Upload to TestFlight
      upload_to_testflight(
        api_key: lane_context[SharedValues::APP_STORE_CONNECT_API_KEY],
        skip_submission: true,
        skip_waiting_for_build_processing: true
      )
      
      UI.success("ğŸ‰ Successfully uploaded to TestFlight!")
      
    rescue => ex
      UI.error("âŒ Build failed: #{ex}")
      UI.important("ğŸ’¡ If this is a certificate/signing error, it's likely due to Apple Developer account permissions")
      UI.important("ğŸ”§ Developer role cannot create Distribution certificates - need Admin or App Store Manager role")
      raise ex
    end
  end

  desc "ğŸ§ª Run unit tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      device: "iPhone 16",
      only_testing: ["CD starter projectTests"]
    )
  end

  desc "ğŸ§ª LOCAL TEST: Test certificate import without API keys"
  lane :test_local_setup do
    UI.header("ğŸ§ª LOCAL TEST: Testing certificate import")
    UI.message("ğŸ” This tests the CI setup without requiring API keys")
    
    begin
      # Test keychain creation
      create_keychain(
        name: "fastlane_tmp_keychain",
        password: "temp_password",
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
      UI.success("âœ… Keychain creation successful")
      
      # Test certificate download and import
      UI.message("ğŸ“¥ Downloading Apple WWDR certificates...")
      sh("curl -o /tmp/AppleWWDRCAG3.cer https://developer.apple.com/certificationauthority/AppleWWDRCAG3.cer")
      import_certificate(
        certificate_path: "/tmp/AppleWWDRCAG3.cer",
        keychain_name: "fastlane_tmp_keychain",
        keychain_password: "temp_password"
      )
      UI.success("âœ… G3 certificate import successful")
      
      # Also import the newer G4 certificate for better compatibility
      sh("curl -o /tmp/AppleWWDRCAG4.cer https://www.apple.com/certificateauthority/AppleWWDRCAG4.cer")
      import_certificate(
        certificate_path: "/tmp/AppleWWDRCAG4.cer",
        keychain_name: "fastlane_tmp_keychain",
        keychain_password: "temp_password"
      )
      UI.success("âœ… G4 certificate import successful")
      
      UI.success("ğŸ‰ Local setup test completed successfully!")
      UI.message("ğŸ’¡ Certificate import is working - CI environment setup is ready")
      
    rescue => ex
      UI.error("âŒ Local setup test failed: #{ex}")
      raise ex
    ensure
      # Clean up
      begin
        delete_keychain(name: "fastlane_tmp_keychain")
        UI.message("ğŸ§¹ Cleaned up test keychain")
      rescue
        # Ignore cleanup errors
      end
    end
  end
end 
