default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      device: "iPhone 16",
      only_testing: ["CD starter projectTests"]
    )
  end

  desc "Build and upload to TestFlight"
  lane :ci_build do
    key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    issuer_id = ENV["APP_STORE_CONNECT_API_ISSUER_ID"]
    key_content = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    
    temp_key_file = nil

    begin
      puts "üîç Starting ci_build lane for TestFlight upload"
      
      # Ensure we have all required API keys
      unless key_id && issuer_id && key_content &&
             !key_id.empty? && !issuer_id.empty? && !key_content.empty?
        UI.user_error!("‚ùå Missing App Store Connect API credentials. Please configure API_KEY_ID, API_ISSUER_ID, and API_KEY_BASE64 secrets.")
      end
      
      puts "üîë Setting up App Store Connect API key..."
      app_store_connect_api_key(
        key_id: key_id,
        issuer_id: issuer_id,
        key_content: key_content,
        is_key_content_base64: true,
        duration: 1200,
        in_house: false
      )
      puts "‚úÖ API key setup successful"
      
      # Create a robust temporary file for the authentication key
      require 'tempfile'
      require 'base64'
      
      temp_key_file = Tempfile.new(["AuthKey_", ".p8"])
      temp_key_path = temp_key_file.path
      
      puts "üìù Creating temporary AuthKey.p8 file at: #{temp_key_path}"
      decoded_key = Base64.decode64(key_content.strip)
      temp_key_file.write(decoded_key)
      temp_key_file.close
      puts "‚úÖ Temporary AuthKey.p8 file created."
      
      puts "üèóÔ∏è  Building for App Store distribution with automatic signing..."
      build_app(
        project: "CD starter project.xcodeproj",
        scheme: "CD starter project",
        export_method: "app-store",
        output_directory: "./build",
        output_name: "CD_starter_project",
        clean: true,
        xcargs: "-allowProvisioningUpdates -authenticationKeyPath #{temp_key_path} -authenticationKeyID #{key_id} -authenticationKeyIssuerID #{issuer_id}",
        export_options: {
          method: "app-store",
          uploadBitcode: false,
          uploadSymbols: true,
          compileBitcode: false
        }
      )
      puts "‚úÖ Build completed successfully"
      
      puts "üöÄ Uploading to TestFlight..."
      upload_to_testflight(
        skip_waiting_for_build_processing: true,
        skip_submission: true,
        changelog: "Automated build from GitHub Actions"
      )
      puts "‚úÖ Successfully uploaded to TestFlight!"
      
    ensure
      # Securely clean up the temporary key file
      if temp_key_file
        temp_key_file.unlink
        puts "üßπ Cleaned up temporary AuthKey.p8 file"
      end
    end
  end
end 