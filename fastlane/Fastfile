# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out:
#   https://docs.fastlane.tools/actions
# For a list of all available plugins, check out:
#   https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  # ---------------------------------------------------------------------------
  # Main entry lane for CI/CD
  # ---------------------------------------------------------------------------
  desc "Build and upload the app to TestFlight"
  lane :build_and_upload do
    setup_ci_environment
    
    build(
      app_identifier: ENV["APP_IDENTIFIER"] || "com.othmanshahrouri.cd.starter.project",
      build_type: "appstore",
      version_number: ENV["VERSION_NUMBER"],
      build_number: ENV["BUILD_NUMBER"]
    )
    
    upload_to_testflight(
      ipa: "./build/CD_starter_project.ipa",
      skip_waiting_for_build_processing: true,
      notify_external_testers: false
    )
    
    UI.success("üéâ Successfully uploaded to TestFlight!")
  end

  # ---------------------------------------------------------------------------
  # Build lane - simplified approach using match + sigh
  # ---------------------------------------------------------------------------
  private_lane :build do |options|
    app_identifier = options[:app_identifier]
    build_type = options[:build_type]
    version_number = options[:version_number]
    build_number = options[:build_number]

    # Set version and build numbers if provided
    if version_number
      increment_version_number(version_number: version_number)
    end
    
    if build_number
      increment_build_number(build_number: build_number)
    end

    # Setup App Store Connect API key
    setup_api_key

    # For automatic signing, we need to authenticate with Apple ID
    UI.message("üîß Setting up Apple ID authentication for automatic signing...")
    
    if ENV["FASTLANE_USERNAME"] && ENV["FASTLANE_PASSWORD"]
      UI.message("üîê Authenticating with Apple ID...")
      # This will authenticate and cache the session
      ENV["FASTLANE_DONT_STORE_PASSWORD"] = "1"
    else
      UI.message("‚ö†Ô∏è Apple ID credentials not found - automatic signing may fail")
      UI.message("Please ensure FASTLANE_USERNAME and FASTLANE_PASSWORD are set")
    end

    # Build the app with explicit automatic signing configuration
    xcargs = "-allowProvisioningUpdates CODE_SIGN_STYLE=Automatic"
    if ENV["DEVELOPMENT_TEAM"]
      xcargs += " DEVELOPMENT_TEAM=#{ENV['DEVELOPMENT_TEAM']}"
    end
    
    gym(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      configuration: "Release",
      output_directory: "./build",
      output_name: "CD_starter_project",
      clean: true,
      export_method: "app-store",
      include_bitcode: false,
      xcargs: xcargs,
      export_options: {
        method: "app-store",
        compileBitcode: false,
        teamID: ENV["DEVELOPMENT_TEAM"]
      }
    )

    UI.success("‚úÖ Build successful!")
  end

  # ---------------------------------------------------------------------------
  # Code signing setup using match, cert, and sigh
  # ---------------------------------------------------------------------------
  private_lane :setup_code_signing do |options|
    build_type = options[:build_type]
    app_identifier = options[:app_identifier]
    
    UI.header("üîë Setting up code signing for #{build_type} build...")

    # Use match for certificate management (if git repo is configured)
    if ENV["MATCH_GIT_URL"] && !ENV["MATCH_GIT_URL"].empty?
      UI.message("üì± Using match for certificate management...")
      
      match(
        type: build_type,
        app_identifier: app_identifier,
        git_url: ENV["MATCH_GIT_URL"],
        username: ENV["FASTLANE_USERNAME"],
        team_id: ENV["DEVELOPMENT_TEAM"],
        readonly: true  # Don't create new certificates in CI
      )
    else
      UI.message("‚ö†Ô∏è No MATCH_GIT_URL configured, using manual certificate import...")
      
      # Import existing certificate from environment variables
      if ENV["DISTRIBUTION_CERTIFICATE"] && ENV["DISTRIBUTION_PASSWORD"]
        UI.message("üìú Importing distribution certificate from environment...")
        
        # Decode and import the certificate
        certificate_path = "/tmp/distribution_certificate.p12"
        File.write(certificate_path, Base64.decode64(ENV["DISTRIBUTION_CERTIFICATE"]))
        
        # Import certificate to keychain
        import_certificate(
          certificate_path: certificate_path,
          certificate_password: ENV["DISTRIBUTION_PASSWORD"],
          keychain_name: "fastlane_tmp_keychain",
          keychain_password: "temp_password"
        )
        
        # Clean up temporary file
        File.delete(certificate_path) if File.exist?(certificate_path)
        
        UI.success("‚úÖ Distribution certificate imported successfully")
      else
        UI.error("‚ùå No distribution certificate found in environment variables")
        UI.error("Please ensure DISTRIBUTION_CERTIFICATE and DISTRIBUTION_PASSWORD are set")
        raise "Missing distribution certificate configuration"
      end
    end

    # Use existing provisioning profile from environment variables
    UI.message("üìã Setting up provisioning profiles from environment...")
    
    if ENV["APP_STORE_PROFILE_BASE64"]
      UI.message("üì± Importing App Store provisioning profile from environment...")
      
      # Decode and save the provisioning profile
      profile_path = "/tmp/appstore_profile.mobileprovision"
      File.write(profile_path, Base64.decode64(ENV["APP_STORE_PROFILE_BASE64"]))
      
      # Install the provisioning profile
      install_provisioning_profile(path: profile_path)
      
      # Clean up temporary file
      File.delete(profile_path) if File.exist?(profile_path)
      
      UI.success("‚úÖ App Store provisioning profile imported successfully")
    else
      UI.error("‚ùå No App Store provisioning profile found in environment variables")
      UI.error("Please ensure APP_STORE_PROFILE_BASE64 is set")
      raise "Missing App Store provisioning profile configuration"
    end

    UI.success("‚úÖ Code signing setup complete!")
  end

  # ---------------------------------------------------------------------------
  # CI Environment setup
  # ---------------------------------------------------------------------------
  private_lane :setup_ci_environment do
    UI.header("üîß Setting up CI environment...")
    
    # Create a temporary keychain for CI
    if is_ci
      create_keychain(
        name: "fastlane_tmp_keychain",
        password: "temp_password",
        default_keychain: true,
        unlock: true,
        timeout: 3600
      )
    end
    
    UI.success("‚úÖ CI environment setup complete!")
  end

  # ---------------------------------------------------------------------------
  # App Store Connect API key setup
  # ---------------------------------------------------------------------------
  private_lane :setup_api_key do
    # Only setup API key if all required environment variables are present
    if ENV["API_KEY_ID"] && ENV["API_ISSUER_ID"] && ENV["API_KEY_BASE64"]
      app_store_connect_api_key(
        key_id: ENV["API_KEY_ID"],
        issuer_id: ENV["API_ISSUER_ID"],
        key_content: ENV["API_KEY_BASE64"],
        is_key_content_base64: true
      )
      UI.success("‚úÖ App Store Connect API key setup successful")
    else
      UI.message("‚ö†Ô∏è App Store Connect API key not configured (missing environment variables)")
    end
  end

  # ---------------------------------------------------------------------------
  # Testing lane
  # ---------------------------------------------------------------------------
  desc "Run unit tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      clean: true,
      device: "iPhone 15",
      only_testing: ["CD starter projectTests"]
    )
  end

  # ---------------------------------------------------------------------------
  # Development helper lanes
  # ---------------------------------------------------------------------------
  desc "Setup certificates and profiles for development"
  lane :setup_dev_signing do
    setup_api_key
    
    setup_code_signing(
      build_type: "development",
      app_identifier: ENV["APP_IDENTIFIER"] || "com.othmanshahrouri.cd.starter.project"
    )
  end

  desc "Setup certificates and profiles for App Store"
  lane :setup_appstore_signing do
    setup_api_key
    
    setup_code_signing(
      build_type: "appstore",
      app_identifier: ENV["APP_IDENTIFIER"] || "com.othmanshahrouri.cd.starter.project"
    )
  end

end
