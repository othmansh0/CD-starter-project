default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      device: "iPhone 16",
      only_testing: ["CD starter projectTests"]
    )
  end

  desc "Build and archive for CI"
  lane :ci_build do
    puts "ğŸ” Debug: Starting ci_build lane"
    
    # Debug environment variables
    key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    issuer_id = ENV["APP_STORE_CONNECT_API_ISSUER_ID"] 
    key_content = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    
    puts "ğŸ” Debug: key_id present: #{!key_id.nil? && !key_id.empty?}"
    puts "ğŸ” Debug: issuer_id present: #{!issuer_id.nil? && !issuer_id.empty?}"
    puts "ğŸ” Debug: key_content present: #{!key_content.nil? && !key_content.empty?}"
    
    # Only setup API key if ALL required environment variables are present and not empty
    if key_id && issuer_id && key_content && 
       !key_id.empty? && !issuer_id.empty? && !key_content.empty?
      
      puts "ğŸ”‘ Setting up App Store Connect API key with key_content..."
      begin
        app_store_connect_api_key(
          key_id: key_id,
          issuer_id: issuer_id,
          key_content: key_content,
          duration: 1200,
          in_house: false
        )
        puts "âœ… API key setup successful"
      rescue => e
        puts "âŒ API key setup failed: #{e.message}"
        puts "âš ï¸  Proceeding without API key setup"
      end
    else
      puts "âš ï¸  App Store Connect API key not fully configured - building without signing"
      puts "ğŸ” Missing: key_id=#{key_id.nil? || key_id.empty?}, issuer_id=#{issuer_id.nil? || issuer_id.empty?}, key_content=#{key_content.nil? || key_content.empty?}"
    end

    puts "ğŸ—ï¸  Starting build process..."
    
    # Build the app
    build_app(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      export_method: "development",
      output_directory: "./build",
      output_name: "CD_starter_project.ipa",
      skip_codesigning: key_content.nil? || key_content.empty?
    )
    
    puts "âœ… Build process completed"
  end
end 