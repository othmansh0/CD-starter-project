default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      device: "iPhone 16",
      only_testing: ["CD starter projectTests"]
    )
  end

  desc "Build and upload to TestFlight"
  lane :ci_build do
    key_id = ENV["API_KEY_ID"]
    issuer_id = ENV["API_ISSUER_ID"]
    key_content = ENV["API_KEY_BASE64"]
    
    puts "üîç Starting ci_build lane for TestFlight upload"
    
    # Ensure we have all required API keys
    unless key_id && issuer_id && key_content &&
           !key_id.empty? && !issuer_id.empty? && !key_content.empty?
      UI.user_error!("‚ùå Missing App Store Connect API credentials. Please configure API_KEY_ID, API_ISSUER_ID, and API_KEY_BASE64 secrets.")
    end
    
    puts "üîë Setting up App Store Connect API key..."
    app_store_connect_api_key(
      key_id: key_id,
      issuer_id: issuer_id,
      key_content: key_content,
      is_key_content_base64: true,
      duration: 1200,
      in_house: false
    )
    puts "‚úÖ API key setup successful"
    
    puts "üèóÔ∏è  Building for App Store distribution..."
    
    # Create AuthKey.p8 file from base64 content for xcodebuild
    begin
      auth_key_content = Base64.decode64(ENV['API_KEY_BASE64'])
      auth_key_path = "/tmp/AuthKey_#{ENV['API_KEY_ID']}.p8"
      
      # Write the binary content directly to file
      File.binwrite(auth_key_path, auth_key_content)
      
      # Debug: Check if file was created
      puts "üìù AuthKey file created at: #{auth_key_path}"
      puts "üìù File exists: #{File.exist?(auth_key_path)}"
      puts "üìù File size: #{File.size(auth_key_path)} bytes" if File.exist?(auth_key_path)
      
      # Verify it's a valid .p8 file by checking the header
      if File.exist?(auth_key_path)
        file_content = File.read(auth_key_path)
        if file_content.include?("-----BEGIN PRIVATE KEY-----")
          puts "‚úÖ Valid .p8 file format detected"
        else
          puts "‚ö†Ô∏è Warning: File doesn't appear to be in .p8 format"
        end
      end
    rescue => e
      UI.user_error!("‚ùå Failed to create AuthKey.p8 file: #{e.message}")
    end
    
    puts "üìã Downloading provisioning profiles..."
    # Download development profile for building
    sigh(
      app_identifier: "com.othmanshahrouri.cd.starter.project",
      development: true,
      force: true,
      readonly: false
    )
    
    # Download app store profile for distribution
    sigh(
      app_identifier: "com.othmanshahrouri.cd.starter.project",
      appstore: true,
      force: true,
      readonly: false
    )
    
    # Use gym with automatic signing and direct API key authentication
    gym(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "CD_starter_project",
      clean: true,
      xcargs: "-allowProvisioningUpdates -authenticationKeyPath #{auth_key_path} -authenticationKeyID #{ENV['API_KEY_ID']} -authenticationKeyIssuerID #{ENV['API_ISSUER_ID']} DEVELOPMENT_TEAM=F62HZKRPDV",
      export_options: {
        method: "app-store",
        uploadBitcode: false,
        uploadSymbols: true,
        compileBitcode: false,
        manageAppVersionAndBuildNumber: false,
        signingStyle: "automatic",
        teamID: ENV['DEVELOPMENT_TEAM'] || "F62HZKRPDV"
      }
    )
    puts "‚úÖ Build completed successfully"
    
    puts "üöÄ Uploading to TestFlight..."
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      changelog: "Automated build from GitHub Actions"
    )
    puts "‚úÖ Successfully uploaded to TestFlight!"
  end
end 