default_platform(:ios)

platform :ios do
  desc "Run tests"
  lane :test do
    run_tests(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      device: "iPhone 16",
      only_testing: ["CD starter projectTests"]
    )
  end

  desc "Build and archive for CI - NO API KEY VERSION"
  lane :ci_build do
    puts "🔍 Starting ci_build lane WITHOUT API key setup"
    puts "🔍 This version completely bypasses API key to isolate the issue"
    
    # Debug environment variables but don't use them
    key_id = ENV["APP_STORE_CONNECT_API_KEY_ID"]
    issuer_id = ENV["APP_STORE_CONNECT_API_ISSUER_ID"] 
    key_content = ENV["APP_STORE_CONNECT_API_KEY_CONTENT"]
    
    puts "🔍 Debug: key_id present: #{!key_id.nil? && !key_id.empty?}"
    puts "🔍 Debug: issuer_id present: #{!issuer_id.nil? && !issuer_id.empty?}"
    puts "🔍 Debug: key_content present: #{!key_content.nil? && !key_content.empty?}"
    
    puts "⚠️  INTENTIONALLY SKIPPING API key setup to test build process"
    puts "🏗️  Starting build process without signing..."
    
    # Build the app without any API key setup
    build_app(
      project: "CD starter project.xcodeproj",
      scheme: "CD starter project",
      export_method: "development",
      output_directory: "./build",
      output_name: "CD_starter_project.ipa",
      skip_codesigning: true,
      skip_package_ipa: false
    )
    
    puts "✅ Build process completed successfully!"
  end
end 