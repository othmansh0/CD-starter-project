name: Build on PR Comment

on:
  issue_comment:
    types: [created]

jobs:
  build-on-comment:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '.build')
    runs-on: macos-latest
    steps:
      - name: Get PR details
        id: pr
        run: |
          pr_number=${{ github.event.issue.number }}
          pr_data=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${pr_number}")
          branch=$(echo "$pr_data" | jq -r '.head.ref')
          base_branch=$(echo "$pr_data" | jq -r '.base.ref')
          head_sha=$(echo "$pr_data" | jq -r '.head.sha')
          echo "branch=${branch}" >> $GITHUB_OUTPUT
          echo "base_branch=${base_branch}" >> $GITHUB_OUTPUT
          echo "head_sha=${head_sha}" >> $GITHUB_OUTPUT

      - name: Check if PR targets develop
        if: steps.pr.outputs.base_branch != 'develop'
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -X POST \
            -d '{"body":"‚ùå Build command only works on PRs targeting the `develop` branch."}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
          exit 1

      - name: Check testing workflow status
        id: check_tests
        run: |
          # Get workflow runs for this PR's latest commit
          workflow_runs=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?head_sha=${{ steps.pr.outputs.head_sha }}")
          
          # Check for testing workflow
          testing_status=$(echo "$workflow_runs" | jq -r '.workflow_runs[] | select(.name=="CD starter project testing workflow") | .status' | head -1)
          testing_conclusion=$(echo "$workflow_runs" | jq -r '.workflow_runs[] | select(.name=="CD starter project testing workflow") | .conclusion' | head -1)
          
          echo "Testing workflow status: $testing_status"
          echo "Testing workflow conclusion: $testing_conclusion"
          
          if [ "$testing_status" = "in_progress" ] || [ "$testing_status" = "queued" ]; then
            echo "Tests are currently running. Please wait."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -X POST \
              -d '{"body":"‚è≥ Please wait until the testing workflow has finished before triggering a build."}' \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
            exit 1
          elif [ "$testing_conclusion" != "success" ]; then
            echo "Tests have not passed. Build cannot proceed."
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -X POST \
              -d '{"body":"‚ùå Build cannot proceed because tests have not passed. Please ensure all tests are passing before triggering a build."}' \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.branch }}

      - name: Select Xcode Version
        run: |
          sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: Install dependencies
        run: |
          bundle install

      - name: Decode App Store Connect Key
        env:
          API_KEY_BASE64: ${{ secrets.API_KEY_BASE64 }}
        run: |
          echo "$API_KEY_BASE64" | base64 --decode > AuthKey.p8

      - name: Add comment - Build started
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -X POST \
            -d '{"body":"üöÄ Build started for this PR branch (tests have passed ‚úÖ)..."}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"

      - name: Build with Fastlane
        env:
          API_KEY_ID: ${{ secrets.API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.API_ISSUER_ID }}
          DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
        run: |
          bundle exec fastlane ci_build

      - name: Add comment - Build success
        if: success()
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -X POST \
            -d '{"body":"‚úÖ Build completed successfully! üéâ This PR is ready for deployment."}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"

      - name: Add comment - Build failed
        if: failure()
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -X POST \
            -d '{"body":"‚ùå Build failed. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments" 